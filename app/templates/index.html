{% extends "base.html" %}
{% block title %}OCR Service - Tổng quan{% endblock %}
{% block content %}
<div class="card">
  <h2>Tải tài liệu mới</h2>
  <p>Chọn động cơ OCR và tải lên tài liệu (ảnh, PDF, Word) để bắt đầu xử lý.</p>
  {% if error %}
  <div class="error">{{ error }}</div>
  {% endif %}
  <form action="/upload" method="post" enctype="multipart/form-data" class="grid two js-loading-form">
    <label>
      <span>Chọn động cơ OCR</span>
      <select
        id="engine-select"
        name="engine"
        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 0.5rem;"
      >
        {% for engine in engines %}
        <option
          value="{{ engine }}"
          data-default-lang="{{ engine_default_langs.get(engine, '') }}"
          {% if engine == selected_engine %}selected{% endif %}
        >
          {{ engine|capitalize }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>Mã ngôn ngữ (lang)</span>
      <input
        id="lang-input"
        type="text"
        name="lang"
        value="{{ selected_lang }}"
        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 0.5rem;"
        placeholder="Ví dụ: vie+eng hoặc vi"
      />
      <span class="form-note">Ví dụ: <code>vie+eng</code> cho Tesseract, <code>vi</code> cho PaddleOCR.</span>
    </label>
    <label>
      <span>Tài liệu đầu vào</span>
      <input
        type="file"
        name="file"
        accept=".png,.jpg,.jpeg,.tiff,.bmp,.pdf,.doc,.docx"
        required
        style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 0.5rem;"
      />
    </label>
    <div class="form-actions">
      <button class="btn" type="submit">Thực hiện OCR</button>
      <span class="form-note">Sau khi hoàn tất sẽ chuyển tới trang chi tiết kết quả.</span>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var select = document.getElementById("engine-select");
    var langInput = document.getElementById("lang-input");
    if (!select || !langInput) {
      return;
    }
    var defaults = {};
    select.querySelectorAll("option").forEach(function (option) {
      defaults[option.value] = option.dataset.defaultLang || "";
    });
    var previousDefault = defaults[select.value] || "";
    if (!langInput.value.trim()) {
      langInput.value = previousDefault;
    }
    updatePlaceholder(previousDefault);

    select.addEventListener("change", function () {
      var nextDefault = defaults[select.value] || "";
      if (!langInput.value.trim() || langInput.value === previousDefault) {
        langInput.value = nextDefault;
      }
      previousDefault = nextDefault;
      updatePlaceholder(nextDefault);
    });

    function updatePlaceholder(defaultLang) {
      if (defaultLang) {
        langInput.placeholder = "Ví dụ: " + defaultLang;
      } else {
        langInput.placeholder = "Ví dụ: vie+eng hoặc vi";
      }
    }
  });
</script>

<div class="card">
  <h2>Lịch sử các lần chạy gần đây</h2>
  {% if runs %}
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Thời gian</th>
          <th>Động cơ</th>
          <th>Ngôn ngữ</th>
          <th>Độ tin cậy</th>
          <th>Kết quả tóm tắt</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for run in runs %}
        <tr>
          <td>{{ run.id }}</td>
          <td>{{ run.created_at.strftime("%d/%m/%Y %H:%M:%S") }}</td>
          <td><span class="tag">{{ run.engine|upper }}</span></td>
          <td>
            {% if run.language %}
              <code>{{ run.language }}</code>
            {% else %}
              Mặc định
            {% endif %}
          </td>
          <td>
            {% if run.best_confidence is not none %}
              {{ run.best_confidence|format_confidence }}
            {% else %}
              N/A
            {% endif %}
          </td>
          <td style="max-width: 360px;">
            {% if run.summary_text %}
              {{ run.summary_text[:120] }}{% if run.summary_text|length > 120 %}…{% endif %}
            {% else %}
              (Chưa có văn bản)
            {% endif %}
          </td>
          <td style="text-align: right;">
            <a class="btn secondary" href="/runs/{{ run.id }}">Xem chi tiết</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>Chưa có lần chạy nào. Hãy tải tài liệu để bắt đầu.</p>
  {% endif %}
</div>
{% endblock %}
